{% extends "base.html" %}
{% block title %}Monthly Expense Summary{% endblock %}
{% block content %}

<h2 class="mt-4">Monthly Expense Tracker</h2>

<!-- Month selector (POST to summary.home) -->
<form method="POST" action="{{ url_for('summary.home') }}" class="row g-3 mt-2 mb-4 align-items-center">
  <div class="col-auto">
    <label for="month" class="col-form-label fs-5 fw-semibold">Select month:</label>
  </div>
  <div class="col-auto">
    <input
      type="month"
      id="month"
      name="month"
      class="form-control"
      value="{{ request.values.get('month') or selected_month or '' }}"
      required
    >
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Show</button>
  </div>
  <!-- Pie chart button to the right; doesn't submit the form -->
  <div class="col-auto">
    <button type="button" id="viewPieBtn" class="btn btn-outline-success">
      View Pie Chart
    </button>
  </div>
</form>

{% set ns = namespace(total=0.0) %}
{% if expenses %}
  {% for e in expenses %}
    {% set ns.total = ns.total + (e.expenseAmount or e.amount or 0)|float %}
  {% endfor %}
{% endif %}

{% if expenses and expenses|length %}
  <div class="mb-3 p-3 bg-light border rounded-3">
    <div class="fs-5 fw-bold mb-0">
      Total: ${{ '%.2f' % ns.total }}
    </div>
    <div class="text-muted small">Items: {{ expenses|length }}</div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">Date</th>
          <th scope="col">Type</th>
          <th scope="col">Category</th>
          <th scope="col">Note</th>
          <th scope="col" class="text-end">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
        {% set amt = (e.expenseAmount or e.amount or 0)|float %}
        {% set raw_date = e.date_str or e.occurredAt or e.expense_date or e.get('date') %}
        <tr>
          <td>{{ (raw_date|string)[:10] }}</td>
          <td class="text-capitalize">{{ e.expenseType or e.type or '' }}</td>
          <td class="text-capitalize">{{ e.expenseCategory or e.categoryName or e.category or '' }}</td>
          <td>{{ e.userNote or e.note or '' }}</td>
          <td class="text-end">${{ '%.2f' % amt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-info">
    No expenses found for {{ selected_month or 'the selected month' }}.
  </div>
{% endif %}

<script>
  (function () {
    const input = document.getElementById('month');
    const btn   = document.getElementById('viewPieBtn');
    const base  = "{{ url_for('summary.get_pie_chart') }}";

    // Prefill current month on first load if empty
    if (input && !input.value) {
      const d = new Date();
      input.value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    // Redirect to pie page with ?month=YYYY-MM (no form submit)
    btn && btn.addEventListener('click', function () {
      const m = input?.value || "";
      window.location.href = m ? `${base}?month=${encodeURIComponent(m)}` : base;
    });
  })();
</script>

{% endblock %}